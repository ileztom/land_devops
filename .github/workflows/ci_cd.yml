name: Automate Version and Push to Docker

on:   
  workflow_dispatch:
  pull_request:
    types: [closed]
    branches:
      - master
        
env:
  RELEASE_BRACH: master

jobs:
  pre-merge-check:
    name: (INF) Print INFORMATION
    runs-on: ubuntu-latest
    outputs:
      release_branch: ${{ env.RELEASE_BRANCH }}
      current_branch: ${{ steps.branch-names.outputs.current_branch }}
    steps:
      - name: Get branch names
        id: branch-names
        uses: tj-actions/branch-names@v8

      - name: Log Info
        id: log-info
        run: |
          echo "EVENT NAME    : ${{ github.event_name }}"
          echo "CURRENT BRANCH: ${{ steps.branch-names.outputs.current_branch }}"
          echo "REF NAME      : ${{ github.ref_name }}"
          
  security: 
    name: (SEC)
    needs: pre-merge-check
    uses: ileztom/land_devops/.github/workflows/sec.yml@master
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
      id-token: write

  tests:
    name: (TST)
    needs: security
    uses: ileztom/land_devops/.github/workflows/test.yml@master
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
      id-token: write
    with: 
      version: alpha

  update-version:
    needs: tests
    name: (VER) Version UP
    uses: ileztom/land_devops/.github/workflows/update-version.yml@master
    with:
      release_branch: ${{ needs.pre-merge-check.outputs.RELEASE_BRANCH }}
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
      id-token: write  

  build:
    name: (BUILD) Build application
    needs: update-version
    uses: ileztom/land_devops/.github/workflows/build.yml@master
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
      id-token: write

  docker:
    name: (CI) Docker push
    needs: [build, update-version, pre-merge-check]
    uses: ileztom/land_devops/.github/workflows/docker.yml@master 
    with:
      tag: ${{ needs.update-version.outputs.tag }}
      release_branch: ${{ needs.pre-merge-check.outputs.RELEASE_BRANCH }}
    secrets:
      dockerhub_token: ${{ secrets.DOCKER_HUB_PASSWORD }}  
      dockerhub_login: ${{ secrets.DOCKER_HUB_LOGIN }}
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
      id-token: write

  changelog:
    name: (VER) Chagelog UP
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
      id-token: write
    runs-on: ubuntu-latest
    needs: update-version
    steps:  
      - name: Сheckout on [${{env.RELEASE_BRACH}}]
        uses: actions/checkout@v4

      - name: update release
        run: |
          git pull
      
      - name: Update changelog.md
        run: | 
          echo "---" >> ${{env.CHANGELOG_FILE}} 
          echo "#### [${{needs.update-version.outputs.tag}}] - $(date +"%Y.%m.%d")    ${{ github.event.pull_request.head.ref }}" >> ${{env.CHANGELOG_FILE}} 
      
      - name: Setup git config
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
      
      - name: Commit
        run: |
          git add .
          git commit -m "[${{needs.update-version.outputs.tag}}] ${{env.CHAGELOG_FILE}}"
          git push -u origin ${{ env.RELEASE_BRACH }} --tags 

      - uses: actions/upload-artifact@v4
        with:
          name: ${{env.CHANGELOG_FILE}}
          path: ${{env.CHANGELOG_FILE}}

      - uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '${{env.CHANGELOG_FILE}} был обновлен. Новая версия доступна в корне репозитория.'
            })
      - uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['changelog-${{needs.update-version.outputs.tag}}']
            })

  telegram_notification:
    name: (TG) Telegram notification
    needs: [docker, update-version]
    uses: ileztom/land_devops/.github/workflows/telegram_notification.yml@master
    with: 
      tag: ${{needs.update-version.outputs.tag}}
      commit_msg: ${{ needs.update-version.outputs.commit_msg }}
    secrets:
      dockerhub_token: ${{ secrets.DOCKER_HUB_PASSWORD }}  
      dockerhub_login: ${{ secrets.DOCKER_HUB_LOGIN }}
      telegram_token: ${{ secrets.TELEGRAM_TOKEN }}
      telegram_to: ${{ secrets.TELEGRAM_RECEIVER_ID }}

  deploy:
    name: (DPL) Deploy
    needs: [telegram_notification, pre-merge-check, update-version]
    uses: ./.github/workflows/deploy.yml
    with: 
      version: v${{ needs.update-version.outputs.tag }}
      container_name: land_devops
      current_branch: ${{ needs.pre-merge-check.outputs.current_branch }}
    secrets: 
      DOCKER_USERNAME: ${{ secrets.DOCKER_HUB_LOGIN }}
    permissions:
      contents: read
      packages: write
      id-token: write
      issues: write
      pull-requests: none
      repository-projects: none
      
  # deploy:
  #   name: (DPL) Deploy
  #   needs: [telegram_notification, pre-merge-check, update-version]
  #   uses: ./.github/workflows/deploy.yml
  #   with: 
  #     version: v${{needs.update-version.outputs.tag}}
  #     container_name: land_devops
  #     current_branch: ${{needs.pre-merge-check.outputs.current_branch}}
  #   secrets: 
  #     DOCKER_USERNAME: ${{ secrets.DOCKER_HUB_LOGIN }}
  #   permissions:
  #     contents: write
  #     pull-requests: write
  #     repository-projects: write
  #     id-token: write
      
